<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Generator</title>
    <link href="https://unpkg.com/@primer/css@^20.2.4/dist/primer.css" rel="stylesheet" />
</head>
<body class="color-bg-default">
    <div class="container-lg p-responsive py-6">
        <h1 class="h1 text-center color-fg-default mb-6">RSS Generator</h1>
        
        <!-- Main Form -->
        <div class="Box color-shadow-large mx-auto" style="max-width: 800px;">
            <form id="rssForm" class="Box-body">
                <!-- Step 1: URL Input -->
                <div class="form-group mb-4">
                    <div class="form-group-header">
                        <h2 class="h4 color-fg-default">1. Enter Website URL</h2>
                    </div>
                    <div class="form-group-body">
                        <input type="url" id="url" required 
                               class="form-control width-full"
                               placeholder="https://example.com/blog">
                        <p class="note">Enter the URL of the website you want to create an RSS feed for</p>
                    </div>
                </div>

                <!-- Step 2: Selector Configuration -->
                <div class="form-group mb-4">
                    <div class="form-group-header">
                        <h2 class="h4 color-fg-default">2. Configure Selectors</h2>
                        <button type="button" onclick="togglePanel()" 
                                class="btn btn-sm btn-outline float-right">
                            Show Selector Helper
                        </button>
                    </div>
                    <div class="form-group-body">
                        <div class="mb-3">
                            <label class="form-label">Title Selector (XPath)</label>
                            <input type="text" id="titleSelector" required 
                                   class="form-control"
                                   placeholder="//article//h2">
                        </div>
                        <div>
                            <label class="form-label">Description Selector (XPath)</label>
                            <input type="text" id="descriptionSelector" required 
                                   class="form-control"
                                   placeholder="//article//p[1]">
                        </div>
                    </div>
                </div>

                <!-- Step 3: Feed Details -->
                <div class="form-group mb-4">
                    <div class="form-group-header">
                        <h2 class="h4 color-fg-default">3. Feed Details (Optional)</h2>
                    </div>
                    <div class="form-group-body">
                        <input type="text" id="feedTitle" 
                               class="form-control mb-2"
                               placeholder="Feed Title">
                        <textarea id="feedDescription" 
                                  class="form-control"
                                  rows="2"
                                  placeholder="Feed Description"></textarea>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">
                    Generate RSS Feed
                </button>
            </form>

            <!-- Results Section -->
            <div id="result" class="Box-body hidden border-top">
                <div class="d-flex flex-justify-between flex-items-center mb-3">
                    <h2 class="h4 color-fg-default">Generated RSS Feed</h2>
                    <button onclick="copyRssUrl()" class="btn btn-sm">
                        Copy RSS URL
                    </button>
                </div>

                <div class="mb-4">
                    <h3 class="h5 color-fg-muted mb-2">Preview</h3>
                    <div id="feedPreview" class="Box p-3 color-bg-subtle">
                        <!-- Feed items will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Selector Helper Panel -->
        <div id="selectorPanel" 
             class="position-fixed right-0 top-0 height-full color-bg-default border-left color-border-muted overflow-y-auto p-3 translate-x-100" 
             style="width: 320px;">
            <div class="d-flex flex-justify-between flex-items-center mb-3">
                <h3 class="h4 color-fg-default">Selector Helper</h3>
                <button onclick="togglePanel()" class="btn-octicon">
                    <svg class="octicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                        <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
                    </svg>
                </button>
            </div>

            <input type="text" id="selectorSearch" 
                   class="form-control mb-2"
                   placeholder="Search selectors...">

            <div class="BtnGroup d-block mb-2">
                <button onclick="filterSelectors('all')" class="BtnGroup-item btn btn-sm">All</button>
                <button onclick="filterSelectors('id')" class="BtnGroup-item btn btn-sm">IDs</button>
                <button onclick="filterSelectors('class')" class="BtnGroup-item btn btn-sm">Classes</button>
            </div>

            <div id="selectorList" class="Box">
                <!-- Selectors will be populated here -->
            </div>
        </div>
    </div>

    <script>
        function copyRssUrl() {
            const currentUrl = window.location.href;
            const url = document.getElementById('url').value;
            const titleSelector = document.getElementById('titleSelector').value;
            const descriptionSelector = document.getElementById('descriptionSelector').value;
            const feedTitle = encodeURIComponent(document.getElementById('feedTitle').value);
            const feedDescription = encodeURIComponent(document.getElementById('feedDescription').value);
            
            const rssUrl = `${currentUrl}generate_rss?url=${encodeURIComponent(url)}&title_selector=${encodeURIComponent(titleSelector)}&description_selector=${encodeURIComponent(descriptionSelector)}&feed_title=${feedTitle}&feed_description=${feedDescription}`;
            
            navigator.clipboard.writeText(rssUrl)
                .then(() => alert('RSS URL copied to clipboard!'))
                .catch(err => alert('Failed to copy URL: ' + err));
        }

        function parseXMLtoHTML(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");
            const items = xmlDoc.getElementsByTagName("item");
            let html = '';

            for (let item of items) {
                const title = item.getElementsByTagName("title")[0]?.textContent || 'No title';
                const link = item.getElementsByTagName("link")[0]?.textContent || '#';
                const description = item.getElementsByTagName("description")[0]?.textContent || 'No description';

                html += `
                    <div class="border-bottom color-border-muted py-3 last:border-bottom-0">
                        <h4 class="h5 color-fg-default mb-1">
                            <a href="${link}" target="_blank" class="color-fg-accent">
                                ${title}
                            </a>
                        </h4>
                        <p class="color-fg-muted mb-0">${description}</p>
                    </div>
                `;
            }

            return html || '<div class="color-fg-muted">No items found in feed</div>';
        }

        // Replace the CSS selector validation with XPath validation
        function isValidXPathSelector(selector) {
            try {
                document.evaluate(selector, document, null, XPathResult.ANY_TYPE, null);
                return true;
            } catch (e) {
                return false;
            }
        }

        // Update the title selector validation
        document.getElementById('titleSelector').addEventListener('input', function(e) {
            const input = e.target;
            const selector = input.value;
            
            if (selector && !isValidXPathSelector(selector)) {
                input.setCustomValidity('Invalid XPath selector');
                input.classList.add('border-red-500');
                
                let errorMsg = input.parentNode.querySelector('.error-message');
                if (!errorMsg) {
                    errorMsg = document.createElement('p');
                    errorMsg.className = 'error-message text-red-500 text-sm mt-1';
                    input.parentNode.appendChild(errorMsg);
                }
                errorMsg.textContent = 'Please enter a valid XPath selector';
            } else {
                input.setCustomValidity('');
                input.classList.remove('border-red-500');
                
                const errorMsg = input.parentNode.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.remove();
                }
            }
        });

        // Update the description selector validation
        document.getElementById('descriptionSelector').addEventListener('input', function(e) {
            const input = e.target;
            const selector = input.value;
            
            if (selector && !isValidXPathSelector(selector)) {
                input.setCustomValidity('Invalid XPath selector');
                input.classList.add('border-red-500');
                
                let errorMsg = input.parentNode.querySelector('.error-message');
                if (!errorMsg) {
                    errorMsg = document.createElement('p');
                    errorMsg.className = 'error-message text-red-500 text-sm mt-1';
                    input.parentNode.appendChild(errorMsg);
                }
                errorMsg.textContent = 'Please enter a valid XPath selector';
            } else {
                input.setCustomValidity('');
                input.classList.remove('border-red-500');
                
                const errorMsg = input.parentNode.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.remove();
                }
            }
        });

        // Update the form submission to include validation
        document.getElementById('rssForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                url: document.getElementById('url').value,
                title_selector: document.getElementById('titleSelector').value,
                description_selector: document.getElementById('descriptionSelector').value,
                feed_title: document.getElementById('feedTitle').value,
                feed_description: document.getElementById('feedDescription').value
            };
            
            try {
                const response = await fetch('/generate_rss', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                const resultDiv = document.getElementById('result');
                resultDiv.classList.remove('hidden');
                
                // Show formatted preview
                const feedPreview = document.getElementById('feedPreview');
                feedPreview.innerHTML = parseXMLtoHTML(result.rss_content);
                
            } catch (error) {
                alert('Error generating RSS feed: ' + error.message);
            }
        });

        let allSelectors = [];

        function togglePanel() {
            const panel = document.getElementById('selectorPanel');
            panel.classList.toggle('translate-x-full');
        }

        async function fetchSelectors(url) {
            try {
                const response = await fetch('/get_selectors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                allSelectors = data.selectors;
                displaySelectors(allSelectors);
                
            } catch (error) {
                console.error('Error fetching selectors:', error);
            }
        }

        function displaySelectors(selectors) {
            const container = document.getElementById('selectorList');
            container.innerHTML = selectors.map(selector => `
                <div class="Box-row">
                    <div class="d-flex flex-justify-between mb-2">
                        <code class="color-fg-accent">${selector.css}</code>
                        <span class="Label">${selector.example} matches</span>
                    </div>
                    
                    <div class="color-fg-muted f6 mb-2">
                        <code>${selector.xpath}</code>
                    </div>
                    
                    <!-- Content samples now always visible -->
                    <div class="color-bg-subtle p-2 mb-2 rounded-2">
                        ${selector.samples.map(sample => `
                            <div class="f6 color-fg-muted mb-1">${sample}</div>
                        `).join('')}
                    </div>
                    
                    <div class="d-flex flex-wrap gap-2">
                        <button onclick="useSelector('${selector.css}', 'title')" 
                                class="btn btn-sm btn-success">Use as Title</button>
                        <button onclick="useSelector('${selector.css}', 'description')" 
                                class="btn btn-sm btn-outline">Use as Description</button>
                    </div>
                </div>
            `).join('');
        }

        // Update the useSelector function to use XPath
        function useSelector(selector, type) {
            const input = document.getElementById(type === 'title' ? 'titleSelector' : 'descriptionSelector');
            // Convert CSS selector to XPath using the server response
            const selectorData = allSelectors.find(s => s.css === selector);
            if (selectorData) {
                input.value = selectorData.xpath;
                input.dispatchEvent(new Event('input'));
            }
        }

        function filterSelectors(type) {
            let filtered = [...allSelectors];
            
            if (type === 'id') {
                filtered = allSelectors.filter(s => s.css.includes('#'));
            } else if (type === 'class') {
                filtered = allSelectors.filter(s => s.css.includes('.'));
            }
            
            displaySelectors(filtered);
        }

        // Add search functionality
        document.getElementById('selectorSearch').addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase();
            const filtered = allSelectors.filter(s => 
                s.css.toLowerCase().includes(search) || 
                s.xpath.toLowerCase().includes(search)
            );
            displaySelectors(filtered);
        });

        // Update the URL input handler to fetch selectors
        document.getElementById('url').addEventListener('change', (e) => {
            const url = e.target.value;
            if (url) {
                fetchSelectors(url);
            }
        });

        // Add preview functionality
        function previewSelector(selector) {
            // Remove any existing highlights
            document.querySelectorAll('.selector-highlight').forEach(el => {
                el.classList.remove('selector-highlight');
            });
            
            // Add highlight class to matching elements
            try {
                document.querySelectorAll(selector).forEach(el => {
                    el.classList.add('selector-highlight');
                    
                    // Scroll first element into view
                    if (el === document.querySelector(selector)) {
                        el.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                });
                
                // Remove highlights after 2 seconds
                setTimeout(() => {
                    document.querySelectorAll('.selector-highlight').forEach(el => {
                        el.classList.remove('selector-highlight');
                    });
                }, 2000);
            } catch (e) {
                console.error('Invalid selector:', e);
            }
        }

        // Add CSS for highlighting
        const style = document.createElement('style');
        style.textContent = `
            .selector-highlight {
                outline: 3px solid #4f46e5 !important; /* indigo-600 */
                background-color: rgba(79, 70, 229, 0.1) !important;
                transition: all 0.3s ease-in-out !important;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
